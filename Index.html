<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      :root { --blue: #0d47a1; --light: #f4f7f6; --yellow: #ffca28; --white: #fff; --text: #333; }
      body { font-family: 'Poppins', sans-serif; background: var(--light); margin: 0; color: var(--text); }
      
      /* Header & Layout */
      .header { background: var(--blue); color: var(--white); padding: 30px 20px 70px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
      .container { max-width: 800px; margin: -50px auto 20px; padding: 0 15px; }

      /* Dashboard Cards */
      .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
      .card { background: var(--white); padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .card h3 { margin: 0; font-size: 0.8rem; color: #777; }
      .card p { margin: 5px 0 0; font-weight: bold; color: var(--blue); font-size: 1.1rem; }

      /* Advanced Filter Box */
      .filter-box { 
        background: var(--white); padding: 20px; border-radius: 12px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; 
        display: flex; flex-direction: column; gap: 10px;
      }
      .filter-row { display: flex; gap: 10px; }
      
      select, input, button { 
        padding: 10px; border-radius: 8px; border: 1px solid #ddd; 
        font-family: inherit; font-size: 14px; width: 100%; box-sizing: border-box; 
      }
      select:focus, input:focus { outline: none; border-color: var(--blue); }
      
      button.btn-refresh { background: var(--yellow); border: none; font-weight: 600; cursor: pointer; color: var(--blue); transition: 0.2s; }
      button.btn-refresh:hover { filter: brightness(0.95); }

      /* Transaction List */
      .list-header { font-size: 0.9em; color: #777; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
      .item { 
        background: var(--white); padding: 15px; border-radius: 12px; margin-bottom: 10px; 
        display: flex; justify-content: space-between; align-items: center; 
        border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
      }
      .item.in { border-left-color: #4caf50; }
      .item.out { border-left-color: #f44336; }
      
      .item-info b { display: block; font-size: 1em; }
      .item-info small { color: #888; font-size: 0.8em; }
      .nominal { font-weight: 600; }
      .nominal.in { color: #4caf50; } .nominal.out { color: #f44336; }

      /* Responsive */
      @media (max-width: 600px) { .filter-row { flex-direction: column; } }
    </style>
  </head>
  <body>
    <div class="header">
      <h2>Laporan Kas</h2>
      <p>Data Keuangan Real-time</p>
    </div>

    <div class="container">
      
      <div class="dashboard">
        <div class="card">
          <h3>Pemasukan</h3>
          <p id="t-masuk">Rp 0</p>
        </div>
        <div class="card">
          <h3>Pengeluaran</h3>
          <p id="t-keluar">Rp 0</p>
        </div>
        <div class="card">
          <h3>Saldo Akhir</h3>
          <p id="t-saldo">Rp 0</p>
        </div>
      </div>

      <div class="filter-box">
        <div class="filter-row">
          <select id="tipe-filter" onchange="setupFilterInput()">
            <option value="bulan">Per Bulan</option>
            <option value="hari">Per Tanggal</option>
            <option value="tahun">Per Tahun</option>
            <option value="semua">Tampilkan Semua</option>
          </select>
          
          <div id="input-container" style="flex:1;">
            </div>
        </div>
        <button class="btn-refresh" onclick="applyFilter()"><i class="fas fa-search"></i> Tampilkan Data</button>
      </div>

      <div class="list-header">
        <span id="label-periode">Periode: Semua Data</span>
        <span id="label-count">0 Transaksi</span>
      </div>
      <div id="loader" style="text-align:center; display:none;">
        <i class="fas fa-spinner fa-spin"></i> Memuat data...
      </div>
      <div id="list-data"></div>
    </div>

    <script>
      let globalData = [];

      // Init saat load
      window.onload = function() {
        setupFilterInput(); // Siapkan input default (Bulan)
        loadDataFromServer(); // Ambil data dari Google Sheet
      };

      // 1. Ambil Data dari Server (Apps Script)
      function loadDataFromServer() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('list-data').innerHTML = '';
        google.script.run.withSuccessHandler(saveAndRender).getDataKas();
      }

      function saveAndRender(data) {
        globalData = data;
        document.getElementById('loader').style.display = 'none';
        applyFilter(); // Filter data setelah dimuat
      }

      // 2. Mengatur Tampilan Input Filter
      function setupFilterInput() {
        const tipe = document.getElementById('tipe-filter').value;
        const container = document.getElementById('input-container');
        const today = new Date();
        
        let html = '';
        
        if (tipe === 'hari') {
          // Input Tanggal Lengkap
          const dateStr = today.toISOString().slice(0, 10);
          html = `<input type="date" id="input-val" value="${dateStr}">`;
        
        } else if (tipe === 'bulan') {
          // Input Bulan & Tahun
          const monthStr = today.toISOString().slice(0, 7);
          html = `<input type="month" id="input-val" value="${monthStr}">`;
        
        } else if (tipe === 'tahun') {
          // Dropdown Tahun (Ambil 5 tahun ke belakang s/d 1 tahun ke depan)
          const curYear = today.getFullYear();
          html = `<select id="input-val">`;
          for(let y = curYear + 1; y >= curYear - 5; y--) {
            html += `<option value="${y}" ${y === curYear ? 'selected' : ''}>${y}</option>`;
          }
          html += `</select>`;
        
        } else {
          // Semua data (disable input)
          html = `<input type="text" disabled value="Semua Data" style="background:#eee;">`;
        }
        
        container.innerHTML = html;
      }

      // 3. Logika Filter Utama
      function applyFilter() {
        const tipe = document.getElementById('tipe-filter').value;
        const inputVal = document.getElementById('input-val') ? document.getElementById('input-val').value : '';
        const listContainer = document.getElementById('list-data');
        
        listContainer.innerHTML = '';

        let tMasuk = 0, tKeluar = 0, count = 0;

        // Filter Array
        const filtered = globalData.filter(item => {
          if (tipe === 'semua') return true;
          
          const itemDate = new Date(item.tanggal); // Convert string ke Date Object
          const y = itemDate.getFullYear();
          const m = String(itemDate.getMonth() + 1).padStart(2, '0');
          const d = String(itemDate.getDate()).padStart(2, '0');

          if (tipe === 'hari') {
             // inputVal format: YYYY-MM-DD
             return `${y}-${m}-${d}` === inputVal;
          } 
          else if (tipe === 'bulan') {
             // inputVal format: YYYY-MM
             return `${y}-${m}` === inputVal;
          } 
          else if (tipe === 'tahun') {
             // inputVal format: YYYY
             return String(y) === inputVal;
          }
          return true;
        });

        // Tampilkan Label Periode
        document.getElementById('label-periode').innerText = 
          tipe === 'semua' ? "Semua Data" : `Filter: ${inputVal}`;

        // Render Data Terfilter
        if (filtered.length === 0) {
          listContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">Tidak ada data transaksi.</div>`;
        } else {
          // Reverse agar yang terbaru diatas
          filtered.slice().reverse().forEach(item => {
            const isMasuk = item.jenis === 'Pemasukan';
            const nominal = Number(item.nominal);
            
            // Hitung total
            if(isMasuk) tMasuk += nominal;
            else tKeluar += nominal;
            count++;

            const dateDisplay = new Date(item.tanggal).toLocaleDateString('id-ID', {
              day: 'numeric', month: 'long', year: 'numeric'
            });

            listContainer.innerHTML += `
              <div class="item ${isMasuk ? 'in' : 'out'}">
                <div class="item-info">
                  <b>${item.keterangan}</b>
                  <small><i class="far fa-calendar"></i> ${dateDisplay}</small>
                </div>
                <div class="nominal ${isMasuk ? 'in' : 'out'}">
                  ${isMasuk ? '+' : '-'} ${formatRupiah(nominal)}
                </div>
              </div>
            `;
          });
        }

        // Update Dashboard
        document.getElementById('t-masuk').innerText = formatRupiah(tMasuk);
        document.getElementById('t-keluar').innerText = formatRupiah(tKeluar);
        document.getElementById('t-saldo').innerText = formatRupiah(tMasuk - tKeluar);
        document.getElementById('label-count').innerText = `${count} Transaksi`;
      }

      // Helper Format Rupiah
      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

    </script>
  </body>
          </html>
  
